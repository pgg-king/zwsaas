import{U as P}from"./simple-uploader.js.c04b5c64.js";import{O as A}from"./ali-oss.2ae0dd0c.js";import{u as E}from"./qiniu-js.8b174ca3.js";import{v as _,w,x as b,y as v,t as l,s as I}from"./index.fc627453.js";import"./vue.4c5758a0.js";import{r as j}from"./@vue.87afd1fa.js";import{m as o,n as q}from"./ant-design-vue.e954adc4.js";function u(){}function V(r){let h,g;const m=j(),n={onSuccess:u,onError:u,onVerifyProgress:u,onProgress:u,onAddFile:u,onFileSubmit:u};r=Object.assign({action:"",type:"file",accessKey:"",secretKey:"",bucket:"",region:"",directory:"",domain:"",uploadToken:"",chunkSize:1,chunk:!0,disabled:!1,isDirectory:!1,multiple:!1,progress:!1,saveFinder:!0,disk:"local",driver:"local",accept:"",params:{},headers:{},options:{}},r),r.driver==="oss"&&(h=new A({accessKeyId:r.accessKey,accessKeySecret:r.secretKey,bucket:r.bucket,region:r.region}));let t=new P(Object.assign({target:r.action,query:e=>Object.assign({type:r.type,file_type:e.fileType,directory:r.directory,disk:r.disk},r.params),testChunks:r.chunk,chunkSize:r.chunk?r.chunkSize*1024*1024:10240*1024*1024,headers:Object.assign({Authorization:_.get(),"App-Name":window["App-Name"],Accept:"application/json, text/plain, */*"},r.headers),checkChunkUploadedByResponse:r.chunk?function(e,a){let s={};try{s=JSON.parse(a)}catch{}return!!((s.data.uploaded_chunks||[]).indexOf(e.offset+1)>=0||s.data.url)}:null},r.options));t.on("fileAdded",function(e,a){if(n.onAddFile(e,a)===!1)return t.removeFile(e),!1}),t.on("filesSubmitted",function(e,a){if(n.onFileSubmit(e,a)===!1&&t.cancel(),e.forEach(s=>{let i=w(s.file);s.pause(),i.watch({progress:function(c){F(c)},success:function(c){i=null,s.uniqueIdentifier=c,r.driver=="local"||r.type=="image"?s.resume():(r.driver==="oss"?U(s,k(s)):r.driver==="qiniu"&&O(s,k(s)),t.removeFile(s))}})}),t.upload(),r.progress){const s=document.getElementsByClassName("tox-dialog__footer");s.length>0&&o.config({getContainer:()=>s[0]}),g=o.loading({duration:0,prefixCls:s.length>0?"ex-message-upload ant-message":"ant-message",content:function(){return m.value}})}});function k(e){return r.directory+e.uniqueIdentifier+"."+e.getExtension()}t.on("fileProgress",function(e,a,s){p(parseInt(t.progress()*100))}),t.on("fileSuccess",function(e,a,s,i){t.removeFile(a);try{const c=JSON.parse(s);if(c.code===200)a.path=c.data.path,y(a,c.data.url);else{if(c.code===80010)return f(),c.data.type==="success"&&n.onSuccess(),q.open(b(c.data)),v(c.data);if(c.code===80020)return f(),c.data.type==="success"&&n.onSuccess(),o.open(b(c.data)),v(c.data);d(c.message)}}catch{d()}}),t.on("fileError",function(e,a,s,i){t.removeFile(a),d(s)});function S(e){r.disabled||(t.assignDrop(e),t.assignBrowse(e,r.isDirectory,!r.multiple,{accept:r.accept}))}function F(e){m.value=l("Uploader.check")+e+"%",n.onVerifyProgress(e)}function p(e){m.value=l("Uploader.uploading")+e+"%",n.onProgress(e)}function f(){g&&(g(),o.destroy(),o.config({getContainer:()=>document.body}))}function y(e,a){f(),r.saveFinder?I({url:"/ex-admin/system/upload",method:"post",data:{data:{cate_id:r.params.cate_id||0,type:e.fileType.indexOf("image")===0?"image":"file",name:e.uniqueIdentifier+"."+e.getExtension(),real_name:e.name,file_type:e.fileType,url:a,ext:e.getExtension(),disk:r.disk,path:e.path,size:e.getSize()}}}).then(s=>{r.progress&&o.success(l("Uploader.success")),n.onSuccess(a)}):(r.progress&&o.success(l("Uploader.success")),n.onSuccess(a))}function d(e){f(),e||(e=l("Uploader.error")),o.error(e),n.onError(e)}function x(e){e.addFile&&(n.onAddFile=e.addFile),e.onFileSubmit&&(n.onAddFile=e.fileSubmit),e.success&&(n.onSuccess=e.success),e.error&&(n.onError=e.error),e.verifyProgress&&(n.onVerifyProgress=e.verifyProgress),e.progress&&(n.onProgress=e.progress)}function U(e,a){h.multipartUpload(a,e.file,{progress:function(s){p(parseInt(s*100))}}).then(s=>{const i=`${r.domain}/${a}`;e.path=a,y(e,i)}).catch(s=>{d(s.message)})}function O(e,a){E(e.file,a,r.uploadToken,{fname:a}).subscribe({next(i){p(parseInt(i.total.percent))},error(i){d(i.message)},complete:()=>{e.path=a;const i=`${r.domain}/${a}`;y(e,i)}})}return{uploader:t,watch:x,options:r,input:S}}export{V as u};
